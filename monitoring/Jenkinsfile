pipeline {
    agent any

    environment {
        PRIVATE_MONITORING_ID = "i-0a120872eb49bee5d"  // 프라이빗 EC2 인스턴스 ID
    }

    stages {
        stage('Checkout Repository') {
            steps {
                script {
                    checkout scm
                }
            }
        }

        stage('Login to ECR') {
            steps {
                script {
                    sh """
                    aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 941377153895.dkr.ecr.ap-northeast-2.amazonaws.com
                    """
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    def commandId = sh(script: """
                        aws ssm send-command --document-name "AWS-RunShellScript" \\
                            --targets Key=instanceIds,Values="${PRIVATE_MONITORING_ID}" \\
                            --parameters 'commands=[
                                "echo \\"✅ 배포 시작: 기존 컨테이너 정리 및 최신 이미지 가져오기\\"",
    
                                "cd /home/ubuntu || exit 1",
    
                                "if [ -d \\"Cloud-repo\\" ]; then",
                                "   echo \\"✅ Cloud-repo 폴더가 존재합니다. Git Pull 수행 중...\\"",
                                "   cd Cloud-repo && git pull origin dev",
                                "else",
                                "   echo \\"❗ Cloud-repo 폴더가 없습니다. Git Clone 수행 중...\\"",
                                "   git clone https://github.com/profect-Oops/Cloud-repo.git && cd Cloud-repo && git checkout dev",
                                "fi",

                                "cd /home/ubuntu/Cloud-repo/monitoring",

                                "echo \\"✅ ECR 로그인 중...\\"",
                                "aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 941377153895.dkr.ecr.ap-northeast-2.amazonaws.com",
    
                                "echo \\"✅ 최신 이미지 Pull...\\"",
                                "docker-compose pull",
    
                                "docker-compose up -d",
                                
                                "echo \\"✅ 컨테이너 실행 상태 확인...\\"",
                                "docker ps -a",
    
                                "echo \\"✅ 컨테이너 헬스 체크...\\"",
                                "sleep 5",
                                "docker inspect --format={{.State.Running}} my-app || echo \\"❌ 컨테이너가 정상적으로 실행되지 않았습니다.\\""
                            ]' \\
                            --region "ap-northeast-2" \\
                            --query "Command.CommandId" --output text
                    """, returnStdout: true).trim()

                    echo "🔍 SSM Command ID: ${commandId}"

                    // SSM 실행 결과 확인
                    sleep 10  // SSM 명령 실행을 위한 대기 시간

                    def ssmStatus = sh(script: """
                        aws ssm list-command-invocations --command-id ${commandId} --details --region ap-northeast-2 \\
                        --query "CommandInvocations[0].Status" --output text
                    """, returnStdout: true).trim()

                    echo "📌 SSM Command Status: ${ssmStatus}"

                    if (ssmStatus != "Success") {
                        error("🚨 SSM 배포 실패! Command ID: ${commandId}")
                    }

                    echo "✅ SSM 배포 성공!"
                }
            }
        }
    }
}