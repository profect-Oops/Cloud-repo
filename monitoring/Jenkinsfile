pipeline {
    agent any

    environment {
        AWS_REGION = credentials('AWS_REGION')  // Jenkins Credentialsì—ì„œ ê°€ì ¸ì˜¤ê¸°
        AWS_ACCOUNT_ID = credentials('AWS_ACCOUNT_ID')
        PRIVATE_MONITORING_ID = credentials('PRIVATE_MONITORING_ID')  // í”„ë¼ì´ë¹— EC2 ID
    }

    stages {
        stage('Checkout Repository') {
            steps {
                script {
                    checkout scm
                }
            }
        }

        stage('Login to ECR') {
            steps {
                script {
                    sh """
                    aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
                    """
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    def commandId = sh(script: """
                        aws ssm send-command --document-name "AWS-RunShellScript" \\
                            --targets Key=instanceIds,Values="${PRIVATE_MONITORING_ID}" \\
                            --parameters 'commands=[
                                "echo \\"âœ… ë°°í¬ ì‹œì‘: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ë° ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°\\"",
    
                                "cd /home/ubuntu || exit 1",
    
                                "echo \\"âœ… AWS CLI ë²„ì „ í™•ì¸...\\"",
                                "aws --version",
    
                                "git clone https://github.com/profect-Oops/Cloud-repo.git && cd Cloud-repo && git checkout dev",
    
                                "cd /home/ubuntu/Cloud-repo/monitoring",
    
                                "echo \\"âœ… ECR ë¡œê·¸ì¸ ì¤‘...\\"",
                                "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com",
    
                                "echo \\"âœ… ìµœì‹  ì´ë¯¸ì§€ Pull...\\"",
                                "docker-compose pull",
    
                                "docker-compose up -d",
                                
                                "echo \\"âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ìƒíƒœ í™•ì¸...\\"",
                                "docker ps -a",
    
                                "echo \\"âœ… ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ ì²´í¬...\\"",
                                "sleep 5",
                                "docker inspect --format={{.State.Running}} my-app || echo \\"âŒ ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\\""
                            ]' \\
                            --region "${AWS_REGION}" \\
                            --query "Command.CommandId" --output text
                    """, returnStdout: true).trim()

                    echo "ğŸ” SSM Command ID: ${commandId}"

                    sleep 10  // SSM ëª…ë ¹ì´ ì‹¤í–‰ë  ì‹œê°„ì„ ì¤Œ

                    def ssmStatus = sh(script: """
                        aws ssm list-command-invocations --command-id ${commandId} --details --region ${AWS_REGION} \\
                        --query "CommandInvocations[0].Status" --output text
                    """, returnStdout: true).trim()

                    echo "ğŸ“Œ SSM Command Status: ${ssmStatus}"

                    if (ssmStatus != "Success") {
                        error("ğŸš¨ SSM ë°°í¬ ì‹¤íŒ¨! Command ID: ${commandId}")
                    }

                    echo "âœ… SSM ë°°í¬ ì„±ê³µ!"
                }
            }
        }
    }
}