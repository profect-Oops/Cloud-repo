pipeline {
    agent any

    environment {
        PRIVATE_MONITORING_ID = "i-0a120872eb49bee5d"  // í”„ë¼ì´ë¹— EC2 ì¸ìŠ¤í„´ìŠ¤ ID
    }

    stages {
        stage('Checkout Repository') {
            steps {
                script {
                    checkout scm
                }
            }
        }

        stage('Login to ECR') {
            steps {
                script {
                    sh """
                    aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 941377153895.dkr.ecr.ap-northeast-2.amazonaws.com
                    """
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    def commandId = sh(script: """
                        aws ssm send-command --document-name "AWS-RunShellScript" \\
                            --targets Key=instanceIds,Values="${PRIVATE_MONITORING_ID}" \\
                            --parameters 'commands=[
                                "echo \\"âœ… ë°°í¬ ì‹œì‘: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ë° ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°\\"",
    
                                "cd /home/ubuntu || exit 1",
    
                                "if [ -d \\"Cloud-repo\\" ]; then",
                                "   echo \\"âœ… Cloud-repo í´ë”ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. Git Pull ìˆ˜í–‰ ì¤‘...\\"",
                                "   cd Cloud-repo && git pull origin dev",
                                "else",
                                "   echo \\"â— Cloud-repo í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. Git Clone ìˆ˜í–‰ ì¤‘...\\"",
                                "   git clone https://github.com/profect-Oops/Cloud-repo.git && cd Cloud-repo && git checkout dev",
                                "fi",

                                "cd /home/ubuntu/Cloud-repo/monitoring",

                                "echo \\"âœ… ECR ë¡œê·¸ì¸ ì¤‘...\\"",
                                "aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 941377153895.dkr.ecr.ap-northeast-2.amazonaws.com",
    
                                "echo \\"âœ… ìµœì‹  ì´ë¯¸ì§€ Pull...\\"",
                                "docker-compose pull",
    
                                "docker-compose up -d",
                                
                                "echo \\"âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ìƒíƒœ í™•ì¸...\\"",
                                "docker ps -a",
    
                                "echo \\"âœ… ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ ì²´í¬...\\"",
                                "sleep 5",
                                "docker inspect --format={{.State.Running}} my-app || echo \\"âŒ ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\\""
                            ]' \\
                            --region "ap-northeast-2" \\
                            --query "Command.CommandId" --output text
                    """, returnStdout: true).trim()

                    echo "ğŸ” SSM Command ID: ${commandId}"

                    // SSM ì‹¤í–‰ ê²°ê³¼ í™•ì¸
                    sleep 10  // SSM ëª…ë ¹ ì‹¤í–‰ì„ ìœ„í•œ ëŒ€ê¸° ì‹œê°„

                    def ssmStatus = sh(script: """
                        aws ssm list-command-invocations --command-id ${commandId} --details --region ap-northeast-2 \\
                        --query "CommandInvocations[0].Status" --output text
                    """, returnStdout: true).trim()

                    echo "ğŸ“Œ SSM Command Status: ${ssmStatus}"

                    if (ssmStatus != "Success") {
                        error("ğŸš¨ SSM ë°°í¬ ì‹¤íŒ¨! Command ID: ${commandId}")
                    }

                    echo "âœ… SSM ë°°í¬ ì„±ê³µ!"
                }
            }
        }
    }
}